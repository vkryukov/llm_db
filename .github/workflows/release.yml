name: Release to Hex

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (no git push, no tag, no GitHub release, no Hex publish)"
        required: false
        type: boolean
        default: false
      hex_dry_run:
        description: "Hex dry run only (run all git/release steps, but skip actual Hex publish)"
        required: false
        type: boolean
        default: false
      skip_tests:
        description: "Skip tests before release"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Disable git hooks
        run: git config core.hooksPath /dev/null

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.16"
          otp-version: "26"

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: mix-${{ runner.os }}-elixir-1.16-otp-26-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            mix-${{ runner.os }}-elixir-1.16-otp-26-

      - name: Install dependencies
        run: |
          set -euo pipefail
          mix deps.get
          MIX_ENV=dev mix deps.compile git_ops

      - name: Run tests
        if: ${{ inputs.skip_tests != true }}
        run: |
          set -euo pipefail
          mix test

      - name: Configure git
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version to CalVer
        id: version
        run: |
          set -euo pipefail
          mix llm_db.version
          VERSION=$(grep -oP '@version "\K[^"]+' mix.exs)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "### Version: $VERSION" >> "$GITHUB_STEP_SUMMARY"

          # Commit version bump with conventional commit format
          if git diff --quiet mix.exs; then
            echo "Version already up to date"
          else
            git add mix.exs
            git commit -m "chore: bump version to $VERSION"
          fi

      - name: Generate changelog and create tag
        if: ${{ inputs.dry_run != true }}
        env:
          MIX_ENV: dev
        run: |
          set -euo pipefail
          # Use --override to set exact version (our CalVer), bypassing semver logic
          mix git_ops.release --yes --override "${{ steps.version.outputs.version }}"

      - name: Push changes and tags
        if: ${{ inputs.dry_run != true }}
        run: |
          set -euo pipefail
          git push origin main
          git push --tags

      - name: Publish to Hex.pm
        env:
          HEX_API_KEY: ${{ secrets.HEX_API_KEY }}
        run: |
          set -euo pipefail
          if [ "${{ inputs.dry_run }}" = "true" ] || [ "${{ inputs.hex_dry_run }}" = "true" ]; then
            echo "### Hex Dry Run - Would publish:" >> "$GITHUB_STEP_SUMMARY"
            mix hex.publish --dry-run
          else
            mix hex.publish --yes
            echo "### Published to Hex.pm" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "- Package: llm_db" >> "$GITHUB_STEP_SUMMARY"
          echo "- Version: ${{ steps.version.outputs.version }}" >> "$GITHUB_STEP_SUMMARY"

      - name: Create GitHub release
        if: ${{ inputs.dry_run != true }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          gh release create "v$VERSION" \
            --title "Release v$VERSION" \
            --notes "See [CHANGELOG.md](CHANGELOG.md) for details."
